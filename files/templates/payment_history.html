{% extends "base.html" %}
{% block content %}
<h2 style="margin-top:24px;">Payment History</h2>

<!-- Search -->
<div class="ph-search-box">
    <form method="POST" class="card" style="max-width:400px;margin:auto;">
        <input type="text" name="search" placeholder="Student Name / Admission No.">
        <input type="submit" value="Search" class="btn">
    </form>
</div>

<!-- Print All Button -->
<button onclick="printAllReceiptsPDF()" class="btn" style="display:block;margin:20px auto;">
    Print All Receipts (PDF)
</button>

<!-- Table -->
<table border="1" style="width:100%;text-align:center;margin-top:18px;" id="phTable">
    <thead>
        <tr>
            <th>Student Name</th>
            <th>Academic Year</th>
            <th>Year</th>
            <th>Group</th>
            <th>Fee Type</th>
            <th>Paid Amount</th>
            <th>Discount</th>
            <th>Balance Remaining</th>
            <th>Bill Number</th>
            <th>Payment Date</th>
            <th>Admission No.</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for p in payments %}
        <tr>
            <td>{{ p.student_name }}</td>
            <td>{{ p.academic_year }}</td>
            <td>{{ p.year }}</td>
            <td>{{ p.group }}</td>
            <td>{{ p.fee_type }}</td>
            <td>{{ "%.2f"|format(p.paid_amount) }}</td>
            <td>
                {% set discount_field = p.fee_type ~ '_discount' %}
                {% set discount = p[discount_field] if discount_field in p else 0 %}
                {{ "%.2f"|format(discount) }}
            </td>
            <td>
                {% set fee_field = p.fee_type ~ '_fee' %}
                {% set fixed = p[fee_field] if fee_field in p else 0 %}
                {% set balance = (fixed - discount - p.paid_amount) if (fixed - discount - p.paid_amount) >= 0 else 0 %}
                {{ "%.2f"|format(balance) }}
            </td>
            <td>{{ p.bill_no }}</td>
            <td>{{ p.payment_date }}</td>
            <td>{{ p.admission_no }}</td>
            <td>
                <button class="btn" onclick='printSingleReceipt(this)'>PDF</button>
                <button class="btn" onclick='deleteReceipt(this)' style="background-color:#e74c3c;">Delete</button>
                <span class="ph-pdf-data" style="display:none;">
                    {{ {
                        "student_name": p.student_name,
                        "academic_year": p.academic_year,
                        "year": p.year or "",
                        "group": p.group or "",
                        "fee_type": p.fee_type or "",
                        "paid_amount": "%.2f"|format(p.paid_amount or 0),
                        "discount": "%.2f"|format(discount),
                        "balance": "%.2f"|format(balance),
                        "bill_no": p.bill_no or "",
                        "payment_date": p.payment_date or "",
                        "admission_no": p.admission_no or "",
                        "fixed_fee": "%.2f"|format(fixed),
                        "payment_id": p.id
                    }|tojson }}
                </span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- JS PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
function printAllReceiptsPDF() {
    const rows = document.querySelectorAll('#phTable tbody tr');
    const doc = new window.jspdf.jsPDF();
    const tableData = [];

    rows.forEach(row => {
        const dataSpan = row.querySelector('.ph-pdf-data');
        if (dataSpan) {
            const data = JSON.parse(dataSpan.textContent);
            tableData.push([
                data.student_name,
                data.academic_year,
                data.year,
                data.group,
                data.fee_type,
                data.fixed_fee,
                data.discount,
                (parseFloat(data.fixed_fee) - parseFloat(data.discount)).toFixed(2),
                data.paid_amount,
                data.balance,
                data.bill_no,
                data.payment_date,
                data.admission_no
            ]);
        }
    });

    if (tableData.length === 0) {
        alert("No receipts to print!");
        return;
    }

    doc.setFontSize(16);
    doc.setTextColor(22, 160, 133);
    doc.text("Aditya Degree College - Payment History", 105, 20, {align: 'center'});

    doc.autoTable({
        startY: 30,
        head: [[
            "Student Name", "Academic Year", "Year", "Group", "Fee Type", "Fixed Fee",
            "Discount", "Net Amount", "Paid", "Balance", "Bill No", "Date", "Admission No"
        ]],
        body: tableData,
        headStyles: {fillColor: [22, 160, 133], textColor: [255, 255, 255]},
        styles: { fontSize: 8, cellPadding: 2 }
    });

    doc.save("All_Receipts_Table_Format.pdf");
}

function printSingleReceipt(button) {
    const row = button.closest("tr");
    const dataSpan = row.querySelector(".ph-pdf-data");
    if (!dataSpan) return alert("Receipt data not found!");

    const data = JSON.parse(dataSpan.textContent);
    const doc = new window.jspdf.jsPDF();
    generatePDFContent(doc, data);
    doc.save(`Receipt_${data.admission_no}_${data.fee_type}.pdf`);
}

function generatePDFContent(doc, data) {
    doc.setFontSize(18);
    doc.setTextColor(22, 160, 133);
    doc.text("ADC Payment Receipt", 105, 20, {align: 'center'});

    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Academic Year: ${data.academic_year}`, 14, 35);
    doc.text(`Year: ${data.year}`, 14, 43);
    doc.text(`Group: ${data.group}`, 14, 51);

    doc.setFont(undefined, 'bold');
    doc.text("Student Name:", 14, 63);
    doc.setFont(undefined, 'normal');
    doc.text(data.student_name, 50, 63);

    doc.setFont(undefined, 'bold');
    doc.text("Admission No:", 14, 71);
    doc.setFont(undefined, 'normal');
    doc.text(data.admission_no, 50, 71);

    let y = 83;
    const labels = [
        ["Fee Type:", data.fee_type],
        ["Fixed Fee:", data.fixed_fee],
        ["Discount:", data.discount],
        ["Net Amount:", (parseFloat(data.fixed_fee) - parseFloat(data.discount)).toFixed(2)],
        ["Paid Amount:", data.paid_amount],
        ["Balance Remaining:", data.balance],
        ["Bill Number:", data.bill_no],
        ["Payment Date:", data.payment_date],
    ];

    labels.forEach(([label, value]) => {
        doc.setFont(undefined, 'bold');
        doc.text(label, 14, y);
        doc.setFont(undefined, 'normal');
        doc.text(String(value), 60, y);
        y += 8;
    });

    doc.setFontSize(10);
    doc.text("Thank you for your payment!", 105, 160, {align: 'center'});
    doc.text("Aditya Degree College", 105, 170, {align: 'center'});
    doc.setDrawColor(200, 200, 200);
    doc.line(14, 150, 196, 150);
}

function deleteReceipt(button) {
    const row = button.closest("tr");
    const dataSpan = row.querySelector(".ph-pdf-data");
    if (!dataSpan) return alert("Receipt data not found!");

    const data = JSON.parse(dataSpan.textContent);

    if (confirm(`Are you sure you want to delete this payment receipt?\nStudent: ${data.student_name}\nAmount: ${data.paid_amount}\nDate: ${data.payment_date}`)) {
        fetch(`/delete_payment/${data.payment_id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert("Payment deleted successfully!");
                row.remove();
            } else {
                alert("Error deleting payment: " + result.error);
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An unexpected error occurred.");
        });
    }
}
</script>
{% endblock %}

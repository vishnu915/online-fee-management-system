{% extends "base.html" %}

{% block content %}
<h2>Fee Payment</h2>

<!-- Search Form -->
<form method="POST" class="card" style="max-width:400px;">
    <input type="text" name="search" placeholder="Student Name / Admission No.">
    <input type="submit" value="Search" class="btn">
</form>

{% if student %}
    <!-- Student Info -->
    <h3>
        {{ student.name }} ({{ student.admission_no }}) |
        {{ student.academic_year }} - 
        {% if '1st' in student.academic_year or 'First' in student.academic_year %}
            1st Year
        {% elif '2nd' in student.academic_year or 'Second' in student.academic_year %}
            2nd Year
        {% elif '3rd' in student.academic_year or 'Third' in student.academic_year %}
            3rd Year
        {% endif %}
        | Group: {{ student.group }}
    </h3>

    <!-- Action Buttons -->
    <p>
        <a href="{{ url_for('manual_fee_entry', student_id=student.id) }}" class="btn">Edit Fee</a>
        <button onclick="printReceipts()" class="btn" style="background-color:green;color:white;">Print All Receipts</button>
    </p>
    
    <!-- Delete Student -->
    <form method="POST" onsubmit="return confirm('Are you sure you want to delete this student and all related data?');">
        <input type="hidden" name="delete_student_id" value="{{ student.id }}">
        <button type="submit" class="btn btn-danger" style="background-color:red; color:white;">Delete Student</button>
    </form>

    <!-- Fee Table -->
    <div id="receipt-section">
        <table border="1" style="width:100%;text-align:center;margin-top:20px;font-size:14px;">
            <thead>
                <tr>
                    <th>Fee Type</th>
                    <th>Fixed Amount</th>
                    <th>Discount</th>
                    <th>Net Amount</th>
                    <th>Paid Amount</th>
                    <th>Balance</th>
                    <th>Pay</th>
                </tr>
            </thead>
            <tbody>
                {% for ft in ['tuition','practical','university','bus','stationary','internship','viva'] %}
                <tr>
                    <td>{{ ft.title() }}</td>
                    <td>{{ fee[ft ~ '_fee'] if fee[ft ~ '_fee'] is defined else 0 }}</td>
                    <td>{{ fee[ft ~ '_discount'] if fee[ft ~ '_discount'] is defined else 0 }}</td>
                    {% set fixed = fee[ft ~ '_fee'] if fee[ft ~ '_fee'] is defined else 0 %}
                    {% set discount = fee[ft ~ '_discount'] if fee[ft ~ '_discount'] is defined else 0 %}
                    {% set net = fixed - discount %}
                    <td>{{ net }}</td>
                    {% set paid = payments | selectattr('fee_type', 'equalto', ft) | map(attribute='paid_amount') | sum %}
                    <td>{{ "%.2f"|format(paid) }}</td>
                    {% set balance = net - paid %}
                    <td>{{ "%.2f"|format(balance if balance > 0 else 0) }}</td>
                    <td>
                        {% if balance > 0 %}
                            <a href="{{ url_for('make_payment', fee_id=fee.id, fee_type=ft) }}" class="btn">Pay</a>
                        {% else %}
                            Paid
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Printable Receipt Content -->
    <div id="printable-content" style="display:none;">
        <div style="text-align:center; margin-bottom:20px;">
            <h2 style="margin:0; font-size:20px;">Aditya Degree College</h2>
            <h3 style="margin:5px 0 15px 0; font-size:16px;">Fee Receipt</h3>
        </div>

        <p><strong>Student:</strong> {{ student.name }} ({{ student.admission_no }})</p>
        <p><strong>Academic Year:</strong> {{ student.academic_year }}</p>
        <p><strong>Group:</strong> {{ student.group }}</p>

        <table border="1" style="width:100%;text-align:center;margin-top:20px;font-size:12px;">
            <thead>
                <tr>
                    <th>Fee Type</th>
                    <th>Fixed</th>
                    <th>Discount</th>
                    <th>Net</th>
                    <th>Paid</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for ft in ['tuition','practical','university','bus','stationary','internship','viva'] %}
                {% set fixed = fee[ft ~ '_fee'] if fee[ft ~ '_fee'] is defined else 0 %}
                {% set discount = fee[ft ~ '_discount'] if fee[ft ~ '_discount'] is defined else 0 %}
                {% set net = fixed - discount %}
                {% set paid = payments | selectattr('fee_type', 'equalto', ft) | map(attribute='paid_amount') | sum %}
                {% set balance = net - paid %}
                <tr>
                    <td>{{ ft.title() }}</td>
                    <td>{{ fixed }}</td>
                    <td>{{ discount }}</td>
                    <td>{{ net }}</td>
                    <td>{{ "%.2f"|format(paid) }}</td>
                    <td>{{ "%.2f"|format(balance if balance > 0 else 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <p style="margin-top:20px;text-align:right;font-size:12px;">Printed on: {{ current_time }}</p>
    </div>

    <!-- JS Print Logic -->
    <script>
        function printReceipts() {
            var printWindow = window.open('', '', 'height=700,width=900');
            var content = document.getElementById('printable-content').innerHTML;
            printWindow.document.write('<html><head><title>Aditya College Fee Receipt</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; font-size: 12px; }');
            printWindow.document.write('table, th, td { border: 1px solid black; border-collapse: collapse; padding: 6px; font-size: 12px; }');
            printWindow.document.write('h2, h3 { margin: 5px 0; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 500);
        }
    </script>
{% endif %}
{% endblock %}
